`firewalld`（Firewall Dynamic）是 **CentOS 7+、RHEL 7+** 等系统默认的动态防火墙管理工具，替代了传统的`iptables`静态配置方式。它支持“区域（Zone）”概念，可动态调整规则（无需重启服务），更适合现代网络环境中灵活的安全策略管理。


## 一、firewalld 核心概念
理解`firewalld`的关键是掌握“区域”和“规则”的逻辑，其核心设计围绕“不同信任级别划分网络环境”展开：

### 1. 区域（Zone）
区域是`firewalld`的核心，每个区域对应一套预设的安全规则，用于定义对不同网络环境的信任程度。可根据网卡连接的网络（如内网、外网、DMZ）为其分配不同区域，实现差异化防护。

| **区域名称** | **信任级别** | **核心规则（默认）** | **适用场景** |
| :--- | :--- | :--- | :--- |
| `trusted` | 最高 | 允许所有入站、出站流量 | 完全信任的网络（如内网服务器集群） |
| `home` | 较高 | 允许常见家庭网络服务（如 SSH、HTTP、DHCP），拒绝其他非必要流量 | 家庭网络 |
| `work` | 中等 | 允许办公网络服务（如 SSH、HTTP、HTTPS），禁用家庭娱乐类端口（如游戏、P2P） | 公司办公网络 |
| `public` | 较低 | 仅允许最基础的必要服务（如 SSH、DHCPv6），拒绝大部分入站流量 | 公共网络（如咖啡馆、酒店 WiFi） |
| `external` | 低 | 允许 SSH（供远程管理），其他入站流量默认拒绝；出站流量伪装（NAT），适合作为网关 | 服务器作为外网网关的场景 |
| `dmz` | 极低 | 仅允许访问 DMZ 区域内服务器的特定服务（如 HTTP、HTTPS），隔离内网与外网 | DMZ 区（如 Web 服务器） |
| `block` | 最低 | 拒绝所有入站流量（仅允许出站），主动发送拒绝响应 | 不信任的网络 |
| `drop` | 最低 | 丢弃所有入站流量（不响应），仅允许出站 | 极高安全需求，避免被探测 |


### 2. 其他核心概念
+ **服务（Service）**：`firewalld`预定义的常见服务（如`ssh`对应 22 端口、`http`对应 80 端口），可直接通过服务名配置规则，无需手动指定端口。
+ **端口（Port）**：直接通过“端口 + 协议”（如`8080/tcp`）配置规则，适用于自定义服务。
+ **富规则（Rich Rule）**：支持更复杂的条件匹配（如指定源 IP、目的 IP、端口范围、日志记录、速率限制），满足精细化安全需求。
+ **伪装（Masquerading）**：即 NAT 功能，允许内网主机通过防火墙的公网 IP 访问互联网。


## 二、firewalld 基础操作（命令行）
`firewalld`的命令行工具为`firewall-cmd`，所有操作需**root 权限**（或加`sudo`）。

### 1. 服务状态管理
```bash
# 1. 查看firewalld服务状态（running为运行中，dead为未运行）
firewall-cmd --state
# 或通过systemctl查看详细状态
systemctl status firewalld

# 2. 启动firewalld
systemctl start firewalld

# 3. 停止firewalld（生产环境谨慎操作）
systemctl stop firewalld

# 4. 设置firewalld开机自启
systemctl enable firewalld

# 5. 禁止firewalld开机自启
systemctl disable firewalld
```

### 2. 区域管理
```bash
# 1. 查看当前默认区域
firewall-cmd --get-default-zone

# 2. 查看所有可用区域
firewall-cmd --get-zones

# 3. 查看指定区域的详细规则（如public区域）
firewall-cmd --zone=public --list-all
# 查看所有区域的规则
firewall-cmd --list-all-zones

# 4. 修改默认区域（如改为dmz）
firewall-cmd --set-default-zone=dmz

# 5. 为网卡分配区域（如将eth0网卡分配到external区域）
# 临时生效（重启后失效）
firewall-cmd --zone=external --change-interface=eth0
# 永久生效 --permanent（需重新加载配置）
firewall-cmd --permanent --zone=external --change-interface=eth0
```


## 三、核心规则配置（服务 / 端口 / 富规则）
`firewalld`的规则配置分为**临时生效**（`--permanent`不添加）和**永久生效**（添加`--permanent`），永久规则需执行`firewall-cmd --reload`后生效。

### 1. 基于“服务（Service）”配置规则
适合常见预定义服务（如 SSH、HTTP、HTTPS），无需记忆端口号。

```bash
# 1. 查看当前区域允许的服务（如默认区域）
firewall-cmd --list-services

# 2. 查看指定区域允许的服务（如public区域）
firewall-cmd --zone=public --list-services

# 3. 临时允许HTTP服务（默认区域）
firewall-cmd --add-service=http

# 4. 永久允许HTTPS服务（public区域）
firewall-cmd --permanent --zone=public --add-service=https
# 重新加载配置，使永久规则生效
firewall-cmd --reload

# 5. 永久移除public区域的FTP服务
firewall-cmd --permanent --zone=public --remove-service=ftp
firewall-cmd --reload
```

### 2. 基于“端口（Port）”配置规则
适合自定义服务（如 Tomcat 的 8080 端口、MySQL 的 3306 端口）。

```bash
# 1. 临时允许8080/tcp端口（默认区域）
firewall-cmd --add-port=8080/tcp

# 2. 永久允许3306/tcp端口（dmz区域，MySQL服务）
firewall-cmd --permanent --zone=dmz --add-port=3306/tcp
firewall-cmd --reload

# 3. 永久允许端口范围（如10000-10010/tcp，默认区域）
firewall-cmd --permanent --add-port=10000-10010/tcp
firewall-cmd --reload

# 4. 永久移除8080/tcp端口（默认区域）
firewall-cmd --permanent --remove-port=8080/tcp
firewall-cmd --reload
```

### 3. 基于“富规则（Rich Rule）”配置复杂规则
富规则支持多条件组合（如指定源 IP、日志记录、速率限制），适合精细化控制。

#### 示例 1：仅允许特定 IP 访问 SSH 服务
```bash
# 永久允许192.168.1.100访问22端口（SSH），拒绝其他IP（默认区域）
firewall-cmd --permanent --add-rich-rule='
rule family="ipv4"
source address="192.168.1.100/32"
port protocol="tcp" port="22" accept
'
# 拒绝其他所有IP访问22端口（需放在允许规则之后）
firewall-cmd --permanent --add-rich-rule='
rule family="ipv4"
port protocol="tcp" port="22" reject
'
firewall-cmd --reload
```

#### 示例 2：限制单 IP 的连接速率（防御简单 DDoS）
```bash
# 永久限制单个IP每分钟最多10个连接到80端口（HTTP），超过则拒绝（public区域）
firewall-cmd --permanent --zone=public --add-rich-rule='
rule family="ipv4"
port protocol="tcp" port="80"
limit value="10/min" accept
'
firewall-cmd --reload
```

#### 示例 3：记录特定流量的日志
```bash
# 永久记录所有访问443端口（HTTPS）的流量到系统日志（默认区域）
firewall-cmd --permanent --add-rich-rule='
rule family="ipv4"
port protocol="tcp" port="443"
log prefix="HTTPS Traffic: " level="info"
accept
'
firewall-cmd --reload
# 查看日志（CentOS/RHEL）
tail -f /var/log/messages | grep "HTTPS Traffic"
```


## 四、高级功能配置
### 1. 端口转发（Port Forwarding）
将防火墙的某个端口转发到内网其他主机的端口（需先开启“伪装”功能）。

```bash
# 1. 永久开启默认区域的伪装（NAT）功能
firewall-cmd --permanent --add-masquerade
firewall-cmd --reload

# 2. 永久将防火墙的80端口（HTTP）转发到内网192.168.1.200的8080端口
firewall-cmd --permanent --add-forward-port=port=80:proto=tcp:toaddr=192.168.1.200:toport=8080
firewall-cmd --reload

# 3. 永久移除端口转发规则
firewall-cmd --permanent --remove-forward-port=port=80:proto=tcp:toaddr=192.168.1.200:toport=8080
firewall-cmd --reload
```

### 2. 自定义服务
若`firewalld`预定义服务中没有所需服务（如自定义的 1234 端口服务），可手动添加自定义服务。

```bash
# 1. 复制预定义服务模板到自定义服务目录
cp /usr/lib/firewalld/services/ssh.xml /etc/firewalld/services/my-service.xml

# 2. 编辑自定义服务（修改端口和名称）
vim /etc/firewalld/services/my-service.xml
# 修改内容如下（端口1234，协议tcp）：
<service>
  <short>My Custom Service</short>
  <description>My custom service on port 1234/tcp</description>
  <port protocol="tcp" port="1234"/>
</service>

# 3. 重新加载firewalld配置
firewall-cmd --reload

# 4. 永久允许自定义服务（默认区域）
firewall-cmd --permanent --add-service=my-service
firewall-cmd --reload
```


## 五、配置注意事项
1. **区分临时与永久规则**：
    - 临时规则（无`--permanent`）：重启`firewalld`或服务器后失效，适合测试场景；
    - 永久规则（有`--permanent`）：需执行`firewall-cmd --reload`生效，重启后仍保留，生产环境必用。
2. **先放行关键服务**：远程管理服务器时，需先确保`ssh`服务已允许（默认允许），避免配置失误导致无法远程登录（若误删 SSH 规则，需通过控制台修复）。
3. **最小权限原则**：仅开放业务必需的服务 / 端口，如数据库（MySQL、Redis）仅允许内网 IP 访问，不对外暴露；Web 服务仅开放 80/443 端口。
4. **结合日志排查问题**：若服务无法访问，可通过富规则添加日志记录，或查看`firewalld`日志（`/var/log/firewalld`），定位被阻断的流量。
5. **避免与 iptables 冲突**：`firewalld`是`iptables`的上层管理工具，二者不能同时启用。若需切换到`iptables`，需先停止并禁用`firewalld`，再安装`iptables-services`。


通过`firewalld`的区域和动态规则特性，可灵活应对不同网络环境的安全需求，尤其适合需要频繁调整规则的生产环境。实际配置时，需根据业务场景选择合适的区域，并结合富规则实现精细化防护。